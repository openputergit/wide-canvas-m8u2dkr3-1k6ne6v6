<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent Packaging Material Questionnaire</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-[Inter]">
    <div x-data="questionnaireApp()" class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-center text-blue-600">Intelligent Packaging Material Recommendation System</h1>
            <p class="text-center text-gray-600 mt-2">Help us improve packaging material selection with your valuable feedback</p>
        </header>
        
        <!-- Tabs Navigation -->
        <div class="mb-8 border-b border-gray-200">
            <ul class="flex flex-wrap -mb-px">
                <li class="mr-2">
                    <button @click="activeTab = 'questionnaire'" :class="{'text-blue-600 border-b-2 border-blue-600 font-medium': activeTab === 'questionnaire', 'text-gray-500 hover:text-gray-700': activeTab !== 'questionnaire'}" class="inline-block p-4 rounded-t-lg">
                        <i class="bi bi-card-checklist mr-2"></i>Questionnaire
                    </button>
                </li>
                <li class="mr-2">
                    <button @click="activeTab = 'responses'; fetchResponses()" :class="{'text-blue-600 border-b-2 border-blue-600 font-medium': activeTab === 'responses', 'text-gray-500 hover:text-gray-700': activeTab !== 'responses'}" class="inline-block p-4 rounded-t-lg">
                        <i class="bi bi-bar-chart-line mr-2"></i>Response Analysis
                    </button>
                </li>
            </ul>
        </div>

        <!-- Loading State -->
        <div x-show="loading" class="flex justify-center items-center h-40">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
            <p class="ml-3 text-blue-500">Loading...</p>
        </div>

        <!-- Questionnaire Tab -->
        <div x-show="activeTab === 'questionnaire' && !loading">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">Questionnaire Form</h2>
                    <span class="text-sm text-gray-500">* Required fields</span>
                </div>
                
                <div class="mb-4 p-3 bg-blue-50 rounded-lg text-sm">
                    <p><i class="bi bi-info-circle mr-2"></i>Fill out this questionnaire to help us understand your packaging material needs and preferences.</p>
                </div>

                <form @submit.prevent="submitForm" class="space-y-8">
                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                        <div class="bg-blue-500 h-2.5 rounded-full" :style="`width: ${calculateProgress()}%`"></div>
                    </div>

                    <!-- Section A -->
                    <div class="border border-gray-200 p-6 rounded-lg">
                        <h2 class="text-xl font-semibold mb-4 text-blue-600">Section A: Demographic Information (Optional)</h2>
                        <p class="text-gray-500 text-sm mb-4">(For research segmentation purposes)</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block mb-2">Name (Optional)</label>
                                <input type="text" x-model="formData.name" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block mb-2">Organization/Company</label>
                                <input type="text" x-model="formData.organization" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block mb-2">Designation</label>
                                <input type="text" x-model="formData.designation" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block mb-2">Industry</label>
                                <select x-model="formData.industry" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Select an industry</option>
                                    <option value="Food & Beverages">Food & Beverages</option>
                                    <option value="Pharmaceuticals">Pharmaceuticals</option>
                                    <option value="Cosmetics">Cosmetics</option>
                                    <option value="Chemicals">Chemicals</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-2">Years of Experience</label>
                                <select x-model="formData.experience" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Select experience</option>
                                    <option value="0-2">0-2 years</option>
                                    <option value="3-5">3-5 years</option>
                                    <option value="6-10">6-10 years</option>
                                    <option value="10+">Above 10 years</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Sections B, C, D -->
                    <template x-for="(section, sectionIndex) in sections" :key="sectionIndex">
                        <div class="border border-gray-200 p-6 rounded-lg">
                            <h2 class="text-xl font-semibold mb-4 text-blue-600" x-text="section.title"></h2>
                            <p class="text-gray-500 text-sm mb-4">Scale: 0 = Strongly Disagree | 9 = Strongly Agree</p>
                            <div class="space-y-6">
                                <template x-for="(question, index) in section.questions" :key="index">
                                    <div class="pb-4">
                                        <div class="flex justify-between items-center mb-2">
                                            <p class="text-gray-800" x-text="`${index + 1}. ${question.text}`"></p>
                                            <div class="text-sm font-medium px-2 py-1 rounded" :class="getRatingColorClass(formData[`section${sectionIndex + 1}_q${index + 1}`])" x-text="formData[`section${sectionIndex + 1}_q${index + 1}`]"></div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-xs">0</span>
                                            <input type="range" 
                                                min="0" 
                                                max="9" 
                                                x-model.number="formData[`section${sectionIndex + 1}_q${index + 1}`]" 
                                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                            <span class="text-xs">9</span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Additional Comments -->
                    <div class="border border-gray-200 p-6 rounded-lg">
                        <h2 class="text-xl font-semibold mb-4 text-blue-600">Additional Comments</h2>
                        <textarea 
                            x-model="formData.comments" 
                            class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            rows="4"
                            placeholder="Please share any additional thoughts or feedback about packaging material selection..."></textarea>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 justify-center">
                        <button type="button" 
                                @click="resetForm"
                                class="bg-gray-200 text-gray-700 px-6 py-2 rounded hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500">
                            Reset Form
                        </button>
                        <button type="submit" 
                                class="bg-blue-500 text-white px-8 py-2 rounded hover:bg-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500"
                                :disabled="submitting">
                            <span x-show="!submitting">Submit Response</span>
                            <span x-show="submitting" class="flex items-center">
                                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Submitting...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Responses Tab -->
        <div x-show="activeTab === 'responses' && !loading" class="space-y-6">
            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-blue-500">
                    <h3 class="text-lg font-medium text-gray-500">Total Responses</h3>
                    <p class="text-3xl font-bold" x-text="responseStats.totalResponses"></p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-green-500">
                    <h3 class="text-lg font-medium text-gray-500">Avg. Section B Score</h3>
                    <p class="text-3xl font-bold" x-text="responseStats.avgSectionB.toFixed(1)"></p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-purple-500">
                    <h3 class="text-lg font-medium text-gray-500">Avg. Section C Score</h3>
                    <p class="text-3xl font-bold" x-text="responseStats.avgSectionC.toFixed(1)"></p>
                </div>
            </div>

            <!-- Charts -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-semibold mb-4">Response Analysis</h2>
                
                <div x-show="!responses.length" class="p-4 bg-gray-100 rounded-lg text-center text-gray-500">
                    <p>No response data available yet. Submit a response to see analysis.</p>
                </div>
                
                <div x-show="responses.length" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Industry Distribution -->
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-medium mb-3">Industry Distribution</h3>
                        <div class="h-64">
                            <canvas id="industryChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Experience Distribution -->
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-medium mb-3">Experience Distribution</h3>
                        <div class="h-64">
                            <canvas id="experienceChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Section Scores -->
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-medium mb-3">Average Section Scores</h3>
                        <div class="h-64">
                            <canvas id="sectionScoresChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Question Analysis -->
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-medium mb-3">Top Rated Questions</h3>
                        <div class="h-64 overflow-auto">
                            <table class="min-w-full">
                                <thead>
                                    <tr>
                                        <th class="text-left py-2">Question</th>
                                        <th class="text-center py-2">Avg. Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(item, index) in topQuestions" :key="index">
                                        <tr class="border-t border-gray-200">
                                            <td class="py-2" x-text="item.text"></td>
                                            <td class="text-center py-2">
                                                <span class="px-2 py-1 rounded text-xs font-medium" 
                                                      :class="getRatingColorClass(item.score)"
                                                      x-text="item.score.toFixed(1)"></span>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Response Data Table -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Response Data</h2>
                    <button @click="downloadCSV" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                        <i class="bi bi-download mr-2"></i>Download CSV
                    </button>
                </div>
                
                <div x-show="!responses.length" class="p-4 bg-gray-100 rounded-lg text-center text-gray-500">
                    <p>No response data available yet.</p>
                </div>
                
                <div x-show="responses.length" class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-2 px-3 text-left">Organization</th>
                                <th class="py-2 px-3 text-left">Industry</th>
                                <th class="py-2 px-3 text-left">Experience</th>
                                <th class="py-2 px-3 text-center">Section B Avg</th>
                                <th class="py-2 px-3 text-center">Section C Avg</th>
                                <th class="py-2 px-3 text-center">Section D Avg</th>
                                <th class="py-2 px-3 text-center">Overall Avg</th>
                                <th class="py-2 px-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(resp, index) in responses" :key="index">
                                <tr class="border-t border-gray-200 hover:bg-gray-50">
                                    <td class="py-2 px-3" x-text="resp.organization || 'N/A'"></td>
                                    <td class="py-2 px-3" x-text="resp.industry || 'N/A'"></td>
                                    <td class="py-2 px-3" x-text="resp.experience || 'N/A'"></td>
                                    <td class="py-2 px-3 text-center">
                                        <span class="px-2 py-1 rounded text-xs font-medium" 
                                              :class="getRatingColorClass(calculateSectionAvg(resp, 'B'))"
                                              x-text="calculateSectionAvg(resp, 'B').toFixed(1)"></span>
                                    </td>
                                    <td class="py-2 px-3 text-center">
                                        <span class="px-2 py-1 rounded text-xs font-medium" 
                                              :class="getRatingColorClass(calculateSectionAvg(resp, 'C'))"
                                              x-text="calculateSectionAvg(resp, 'C').toFixed(1)"></span>
                                    </td>
                                    <td class="py-2 px-3 text-center">
                                        <span class="px-2 py-1 rounded text-xs font-medium" 
                                              :class="getRatingColorClass(calculateSectionAvg(resp, 'D'))"
                                              x-text="calculateSectionAvg(resp, 'D').toFixed(1)"></span>
                                    </td>
                                    <td class="py-2 px-3 text-center">
                                        <span class="px-2 py-1 rounded text-xs font-medium" 
                                              :class="getRatingColorClass(calculateOverallAvg(resp))"
                                              x-text="calculateOverallAvg(resp).toFixed(1)"></span>
                                    </td>
                                    <td class="py-2 px-3 text-center">
                                        <button @click="viewResponseDetails(resp)" class="text-blue-500 hover:text-blue-700 mr-2">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button @click="deleteResponse(index)" class="text-red-500 hover:text-red-700">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Response Details Modal -->
        <div x-show="showResponseModal" 
             class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50"
             x-transition>
            <div @click.away="showResponseModal = false" class="bg-white p-6 rounded-lg shadow-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Response Details</h2>
                    <button @click="showResponseModal = false" class="text-gray-500 hover:text-gray-700">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- Demographic Information -->
                    <div class="border-b pb-4">
                        <h3 class="font-medium mb-2">Demographic Information</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-gray-500">Name:</p>
                                <p x-text="selectedResponse.name || 'Not provided'"></p>
                            </div>
                            <div>
                                <p class="text-gray-500">Organization:</p>
                                <p x-text="selectedResponse.organization || 'Not provided'"></p>
                            </div>
                            <div>
                                <p class="text-gray-500">Designation:</p>
                                <p x-text="selectedResponse.designation || 'Not provided'"></p>
                            </div>
                            <div>
                                <p class="text-gray-500">Industry:</p>
                                <p x-text="selectedResponse.industry || 'Not provided'"></p>
                            </div>
                            <div>
                                <p class="text-gray-500">Experience:</p>
                                <p x-text="selectedResponse.experience || 'Not provided'"></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section Responses -->
                    <template x-for="(section, sIndex) in sections" :key="sIndex">
                        <div class="border-b pb-4">
                            <h3 class="font-medium mb-2" x-text="section.title"></h3>
                            <div class="space-y-2">
                                <template x-for="(question, qIndex) in section.questions" :key="qIndex">
                                    <div>
                                        <div class="flex justify-between">
                                            <p x-text="`${qIndex + 1}. ${question.text}`"></p>
                                            <span class="px-2 py-1 rounded text-xs font-medium" 
                                                  :class="getRatingColorClass(selectedResponse[`section${sIndex + 1}_q${qIndex + 1}`])"
                                                  x-text="selectedResponse[`section${sIndex + 1}_q${qIndex + 1}`]"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                    
                    <!-- Comments -->
                    <div>
                        <h3 class="font-medium mb-2">Additional Comments</h3>
                        <p x-text="selectedResponse.comments || 'No comments provided'"></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Database Configuration Modal -->
        <div x-show="showDatabaseConfigModal" 
             class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50"
             x-transition>
            <div @click.away="showDatabaseConfigModal = false" class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Database Configuration</h2>
                    <button @click="showDatabaseConfigModal = false" class="text-gray-500 hover:text-gray-700">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block mb-2">API Endpoint</label>
                        <input type="text" x-model="dbConfig.apiEndpoint" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block mb-2">API Key</label>
                        <input type="text" x-model="dbConfig.apiKey" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="flex justify-end mt-4">
                        <button @click="saveDbConfig" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                            Save Configuration
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Message -->
        <div x-show="success" 
             x-transition
             @click="success = false"
             class="fixed top-4 right-4 bg-green-500 text-white p-4 rounded shadow-lg cursor-pointer z-50">
            <div class="flex items-center">
                <i class="bi bi-check-circle-fill mr-2"></i>
                <p x-text="successMsg"></p>
            </div>
        </div>
        
        <!-- Error Message -->
        <div x-show="error" 
             x-transition
             @click="error = false"
             class="fixed top-4 right-4 bg-red-500 text-white p-4 rounded shadow-lg cursor-pointer z-50">
            <div class="flex items-center">
                <i class="bi bi-exclamation-circle-fill mr-2"></i>
                <p x-text="errorMsg"></p>
            </div>
        </div>

        <!-- Floating Action Button -->
        <div class="fixed bottom-6 right-6">
            <div class="relative">
                <button @click="showFloatingMenu = !showFloatingMenu" class="bg-blue-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg hover:bg-blue-700 focus:outline-none">
                    <i class="bi" :class="showFloatingMenu ? 'bi-x-lg' : 'bi-three-dots'"></i>
                </button>
                
                <div x-show="showFloatingMenu" 
                     x-transition
                     class="absolute bottom-16 right-0 bg-white rounded-lg shadow-xl w-48 overflow-hidden">
                    <div class="py-1">
                        <button @click="openDbConfig" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center">
                            <i class="bi bi-database mr-2"></i> Configure API
                        </button>
                        <button @click="refreshData" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center">
                            <i class="bi bi-arrow-clockwise mr-2"></i> Refresh Data
                        </button>
                        <button @click="downloadCSV" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center">
                            <i class="bi bi-download mr-2"></i> Download CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global chart instances
        let industryChart = null;
        let experienceChart = null;
        let sectionScoresChart = null;
        
        function questionnaireApp() {
            return {
                activeTab: 'questionnaire',
                loading: false,
                submitting: false,
                success: false,
                successMsg: 'Form submitted successfully! Thank you for your feedback.',
                error: false,
                errorMsg: '',
                showResponseModal: false,
                showDatabaseConfigModal: false,
                showFloatingMenu: false,
                selectedResponse: {},
                dbConfig: {
                    apiEndpoint: 'https://sheetdb.io/api/v1/041zarh6q2r99',
                    apiKey: '041zarh6q2r99'
                },
                formData: {
                    name: '',
                    organization: '',
                    designation: '',
                    industry: '',
                    experience: '',
                    comments: ''
                },
                responses: [],
                responseStats: {
                    totalResponses: 0,
                    avgSectionB: 0,
                    avgSectionC: 0,
                    avgSectionD: 0
                },
                topQuestions: [],
                sections: [
                    {
                        title: 'Section B: User Perception and Requirements',
                        questions: [
                            { text: 'I face challenges in manually selecting appropriate packaging materials for my product.' },
                            { text: 'I believe packaging material selection is a time-consuming process.' },
                            { text: 'I consider product shelf life and storage conditions when selecting packaging material.' },
                            { text: 'I consider cost-effectiveness while selecting packaging materials.' },
                            { text: 'I prioritize sustainability and environmental friendliness in packaging material selection.' },
                            { text: 'I believe automated systems can simplify packaging material selection.' }
                        ]
                    },
                    {
                        title: 'Section C: Technology Acceptance and Recommendation System',
                        questions: [
                            { text: 'I understand how Machine Learning can improve packaging material selection.' },
                            { text: 'I would prefer an intelligent system that provides material recommendations based on product requirements.' },
                            { text: 'I believe AI-based material recommendations will improve decision-making speed.' },
                            { text: 'I trust machine learning algorithms to suggest suitable packaging materials.' },
                            { text: 'I am concerned about the accuracy and reliability of automated recommendations.' },
                            { text: 'I would like a system that includes customer preferences in its recommendations.' }
                        ]
                    },
                    {
                        title: 'Section D: Expected Outcomes and Satisfaction',
                        questions: [
                            { text: 'An AI-powered recommendation system would improve my overall satisfaction in material selection.' },
                            { text: 'Implementation of such a system would reduce my packaging material selection errors.' },
                            { text: 'I believe such a system will offer my business a competitive advantage.' },
                            { text: 'I am willing to adopt this system in my organization.' },
                            { text: 'I would recommend this system to other companies in the industry.' }
                        ]
                    }
                ],

                init() {
                    // Initialize all ratings to 0
                    this.sections.forEach((section, sIndex) => {
                        section.questions.forEach((_, qIndex) => {
                            this.formData[`section${sIndex + 1}_q${qIndex + 1}`] = 0;
                        });
                    });
                    
                    // Load saved configuration if exists
                    const savedConfig = localStorage.getItem('packagingAppConfig');
                    if (savedConfig) {
                        try {
                            this.dbConfig = JSON.parse(savedConfig);
                        } catch (e) {
                            console.error("Error parsing saved config:", e);
                        }
                    }
                    
                    // Load data from API
                    this.loadInitialData();
                },

                getRatingColorClass(rating) {
                    rating = parseFloat(rating);
                    if (rating >= 7) return 'bg-green-100 text-green-800';
                    if (rating >= 4) return 'bg-blue-100 text-blue-800';
                    return 'bg-gray-100 text-gray-800';
                },
                
                calculateProgress() {
                    // Count filled fields (excluding optional ones)
                    let filledCount = 0;
                    let totalFields = 0;
                    
                    // Count demographic fields (excluding name which is optional)
                    ['organization', 'designation', 'industry', 'experience'].forEach(field => {
                        if (this.formData[field]) filledCount++;
                        totalFields++;
                    });
                    
                    // Count ratings
                    this.sections.forEach((section, sIndex) => {
                        section.questions.forEach((_, qIndex) => {
                            const fieldName = `section${sIndex + 1}_q${qIndex + 1}`;
                            if (this.formData[fieldName] !== undefined) filledCount++;
                            totalFields++;
                        });
                    });
                    
                    return Math.round((filledCount / totalFields) * 100);
                },
                
                async loadInitialData() {
                    this.loading = true;
                    try {
                        await this.fetchResponses();
                    } catch (error) {
                        console.error("Error loading initial data:", error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                viewResponseDetails(response) {
                    this.selectedResponse = response;
                    this.showResponseModal = true;
                },
                
                async submitForm() {
                    this.submitting = true;
                    
                    try {
                        // Validate required fields - make organization required
                        if (!this.formData.organization) {
                            throw new Error('Organization/Company is required');
                        }
                        
                        // Use the configured API endpoint
                        const response = await fetch(this.dbConfig.apiEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ data: [this.formData] })
                        });

                        if (response.ok) {
                            // Add submitted form data to local responses
                            this.responses.push({...this.formData});
                            this.updateResponseStats();
                            this.updateCharts();
                            
                            this.success = true;
                            this.successMsg = 'Form submitted successfully! Thank you for your feedback.';
                            setTimeout(() => this.success = false, 3000);
                            
                            // Store in MongoDB as well for redundancy
                            await this.storeInMongoDB({...this.formData});
                            
                            this.resetForm();
                        } else {
                            throw new Error('Form submission failed');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        this.error = true;
                        this.errorMsg = error.message || 'An error occurred while submitting the form. Please try again.';
                        setTimeout(() => this.error = false, 3000);
                    } finally {
                        this.submitting = false;
                    }
                },
                
                async storeInMongoDB(data) {
                    try {
                        // Also store data in MongoDB
                        await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer 9qVU9vgW1AdSZJL4WNZ2fzKtFC72',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                appSlug: 'packaging-questionnaire-app-101', 
                                action: 'create',
                                collection: 'responses',
                                data: {
                                    ...data,
                                    createdAt: new Date().toISOString()
                                }
                            })
                        });
                    } catch (error) {
                        console.error('MongoDB backup failed:', error);
                        // Don't throw here, as the primary storage already succeeded
                    }
                },
                
                resetForm() {
                    this.formData = {
                        name: '',
                        organization: '',
                        designation: '',
                        industry: '',
                        experience: '',
                        comments: ''
                    };
                    
                    // Reset all section ratings
                    this.sections.forEach((section, sIndex) => {
                        section.questions.forEach((_, qIndex) => {
                            this.formData[`section${sIndex + 1}_q${qIndex + 1}`] = 0;
                        });
                    });
                },
                
                async fetchResponses() {
                    try {
                        // First try to fetch from SheetDB API
                        const response = await fetch(this.dbConfig.apiEndpoint, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            this.responses = Array.isArray(data) ? data : [];
                            
                            // If no data from SheetDB, try to fetch from MongoDB
                            if (this.responses.length === 0) {
                                await this.fetchFromMongoDB();
                            }
                        } else {
                            // If SheetDB fails, try MongoDB
                            await this.fetchFromMongoDB();
                        }
                        
                        // If still no responses, fall back to sample data
                        if (this.responses.length === 0) {
                            await this.parseCSVFiles();
                        }
                        
                        // Update stats and charts based on received data
                        this.updateResponseStats();
                        this.updateCharts();
                    } catch (error) {
                        console.error("Error fetching responses:", error);
                        // Try CSV files as a fallback
                        await this.parseCSVFiles(); 
                        this.error = true;
                        this.errorMsg = 'Failed to load responses from API. Using local data instead.';
                        setTimeout(() => this.error = false, 3000);
                    }
                },
                
                async fetchFromMongoDB() {
                    try {
                        const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer 9qVU9vgW1AdSZJL4WNZ2fzKtFC72',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                appSlug: 'packaging-questionnaire-app-101',
                                action: 'read',
                                collection: 'responses'
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            if (result.success && Array.isArray(result.result)) {
                                this.responses = result.result;
                            }
                        } else {
                            throw new Error('Failed to fetch from MongoDB');
                        }
                    } catch (error) {
                        console.error("Error fetching from MongoDB:", error);
                        throw error; // Propagate error to try the next fallback
                    }
                },
                
                async parseCSVFiles() {
                    try {
                        const csvFiles = [
                            'https://db.zetaverse.one/storage/v1/object/public/app-uploads/spreadsheet-1743225172384/9qVU9vgW1AdSZJL4WNZ2fzKtFC72/kg1cbepf.xlsx',
                            'https://db.zetaverse.one/storage/v1/object/public/app-uploads/spreadsheet-1743225258606/9qVU9vgW1AdSZJL4WNZ2fzKtFC72/63xf2zqw.xlsx'
                        ];
                        
                        // Use sample data for demonstration since we can't directly parse Excel files from URLs
                        // In a real app, we would convert the Excel files to CSV or process them on the server
                        this.responses = this.getSampleResponses();
                    } catch (error) {
                        console.error("Error parsing CSV files:", error);
                    }
                },
                
                getSampleResponses() {
                    // Generate sample data if we can't load real data
                    const sampleData = [];
                    
                    const industries = ['Food & Beverages', 'Pharmaceuticals', 'Cosmetics', 'Chemicals', 'Other'];
                    const experiences = ['0-2', '3-5', '6-10', '10+'];
                    
                    for (let i = 0; i < 10; i++) {
                        const data = {
                            name: `Respondent ${i+1}`,
                            organization: `Company ${i+1}`,
                            designation: ['Manager', 'Director', 'VP', 'Specialist'][Math.floor(Math.random() * 4)],
                            industry: industries[Math.floor(Math.random() * industries.length)],
                            experience: experiences[Math.floor(Math.random() * experiences.length)],
                            comments: i % 3 === 0 ? 'This is a sample comment for testing the application.' : ''
                        };
                        
                        // Add section responses
                        this.sections.forEach((section, sIndex) => {
                            section.questions.forEach((_, qIndex) => {
                                data[`section${sIndex + 1}_q${qIndex + 1}`] = Math.floor(Math.random() * 10);
                            });
                        });
                        
                        sampleData.push(data);
                    }
                    
                    return sampleData;
                },
                
                updateResponseStats() {
                    if (!this.responses.length) {
                        this.responseStats = {
                            totalResponses: 0,
                            avgSectionB: 0,
                            avgSectionC: 0,
                            avgSectionD: 0
                        };
                        return;
                    }
                    
                    let sectionB = 0, sectionC = 0, sectionD = 0;
                    
                    this.responses.forEach(resp => {
                        sectionB += this.calculateSectionAvg(resp, 'B');
                        sectionC += this.calculateSectionAvg(resp, 'C');
                        sectionD += this.calculateSectionAvg(resp, 'D');
                    });
                    
                    this.responseStats = {
                        totalResponses: this.responses.length,
                        avgSectionB: sectionB / this.responses.length,
                        avgSectionC: sectionC / this.responses.length,
                        avgSectionD: sectionD / this.responses.length
                    };
                    
                    // Calculate top questions
                    this.calculateTopQuestions();
                },
                
                calculateSectionAvg(response, section) {
                    const sectionIndex = {'B': 1, 'C': 2, 'D': 3}[section];
                    let total = 0, count = 0;
                    
                    const questionCount = this.sections[sectionIndex-1].questions.length;
                    
                    for (let i = 1; i <= questionCount; i++) {
                        const value = parseFloat(response[`section${sectionIndex}_q${i}`]);
                        if (!isNaN(value)) {
                            total += value;
                            count++;
                        }
                    }
                    
                    return count > 0 ? total / count : 0;
                },
                
                calculateOverallAvg(response) {
                    const sectionsAvg = [
                        this.calculateSectionAvg(response, 'B'),
                        this.calculateSectionAvg(response, 'C'),
                        this.calculateSectionAvg(response, 'D')
                    ];
                    
                    return sectionsAvg.reduce((a, b) => a + b, 0) / 3;
                },
                
                calculateTopQuestions() {
                    if (!this.responses.length) return;
                    
                    const questionScores = [];
                    
                    // Calculate average score for each question
                    this.sections.forEach((section, sIndex) => {
                        section.questions.forEach((question, qIndex) => {
                            const questionKey = `section${sIndex + 1}_q${qIndex + 1}`;
                            let total = 0, count = 0;
                            
                            this.responses.forEach(resp => {
                                const value = parseFloat(resp[questionKey]);
                                if (!isNaN(value)) {
                                    total += value;
                                    count++;
                                }
                            });
                            
                            const avgScore = count > 0 ? total / count : 0;
                            questionScores.push({
                                text: question.text,
                                score: avgScore,
                                section: sIndex + 1
                            });
                        });
                    });
                    
                    // Sort by score descending and take top 10
                    this.topQuestions = questionScores.sort((a, b) => b.score - a.score).slice(0, 10);
                },
                
                updateCharts() {
                    if (this.activeTab === 'responses' && this.responses.length > 0) {
                        setTimeout(() => {
                            this.createIndustryChart();
                            this.createExperienceChart();
                            this.createSectionScoresChart();
                        }, 100);
                    }
                },
                
                createIndustryChart() {
                    // Count responses by industry
                    const industries = {};
                    this.responses.forEach(resp => {
                        const industry = resp.industry || 'Not Specified';
                        industries[industry] = (industries[industry] || 0) + 1;
                    });
                    
                    const labels = Object.keys(industries);
                    const data = Object.values(industries);
                    
                    const ctx = document.getElementById('industryChart');
                    if (!ctx) return;
                    
                    // Destroy existing chart if it exists
                    if (Chart.getChart(ctx)) {
                        Chart.getChart(ctx).destroy();
                    }
                    
                    industryChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: [
                                    '#4F46E5', '#2563EB', '#3B82F6', '#60A5FA', '#93C5FD'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'right',
                                }
                            }
                        }
                    });
                },
                
                createExperienceChart() {
                    // Count responses by experience
                    const experiences = {};
                    this.responses.forEach(resp => {
                        const exp = resp.experience || 'Not Specified';
                        experiences[exp] = (experiences[exp] || 0) + 1;
                    });
                    
                    const labels = Object.keys(experiences);
                    const data = Object.values(experiences);
                    
                    const ctx = document.getElementById('experienceChart');
                    if (!ctx) return;
                    
                    // Destroy existing chart if it exists
                    if (Chart.getChart(ctx)) {
                        Chart.getChart(ctx).destroy();
                    }
                    
                    experienceChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Number of Responses',
                                data: data,
                                backgroundColor: '#3B82F6',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                }
                            }
                        }
                    });
                },
                
                createSectionScoresChart() {
                    const ctx = document.getElementById('sectionScoresChart');
                    if (!ctx) return;
                    
                    // Destroy existing chart if it exists
                    if (Chart.getChart(ctx)) {
                        Chart.getChart(ctx).destroy();
                    }
                    
                    sectionScoresChart = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: ['User Perception (B)', 'Technology Acceptance (C)', 'Expected Outcomes (D)'],
                            datasets: [{
                                label: 'Average Score',
                                data: [
                                    this.responseStats.avgSectionB,
                                    this.responseStats.avgSectionC,
                                    this.responseStats.avgSectionD
                                ],
                                fill: true,
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                borderColor: '#3B82F6',
                                pointBackgroundColor: '#3B82F6',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: '#3B82F6'
                            }]
                        },
                        options: {
                            scales: {
                                r: {
                                    min: 0,
                                    max: 9,
                                    ticks: {
                                        stepSize: 3
                                    }
                                }
                            }
                        }
                    });
                },
                
                openDbConfig() {
                    this.showDatabaseConfigModal = true;
                    this.showFloatingMenu = false;
                },
                
                saveDbConfig() {
                    try {
                        // Validate the config
                        if (!this.dbConfig.apiEndpoint) {
                            throw new Error('API Endpoint is required');
                        }
                        
                        // Save to local storage
                        localStorage.setItem('packagingAppConfig', JSON.stringify(this.dbConfig));
                        
                        this.success = true;
                        this.successMsg = 'Database configuration saved successfully!';
                        setTimeout(() => this.success = false, 3000);
                        
                        // Close the modal
                        this.showDatabaseConfigModal = false;
                        
                        // Refresh data with new config
                        this.fetchResponses();
                    } catch (error) {
                        this.error = true;
                        this.errorMsg = error.message;
                        setTimeout(() => this.error = false, 3000);
                    }
                },
                
                refreshData() {
                    this.fetchResponses();
                    this.showFloatingMenu = false;
                },
                
                async deleteResponse(index) {
                    if (!confirm('Are you sure you want to delete this response?')) return;
                    
                    try {
                        const response = this.responses[index];
                        
                        // If there's an _id, try to delete from MongoDB
                        if (response._id) {
                            await this.deleteFromMongoDB(response._id);
                        }
                        
                        // Also try to delete from SheetDB
                        // Note: SheetDB requires a specific identifier column, which we don't have here
                        // In a real app, you would need to implement proper deletion from SheetDB
                        
                        // Remove from local array
                        this.responses.splice(index, 1);
                        
                        // Update stats and charts
                        this.updateResponseStats();
                        this.updateCharts();
                        
                        this.success = true;
                        this.successMsg = 'Response deleted successfully';
                        setTimeout(() => this.success = false, 3000);
                    } catch (error) {
                        console.error('Error deleting response:', error);
                        this.error = true;
                        this.errorMsg = 'Failed to delete response. ' + error.message;
                        setTimeout(() => this.error = false, 3000);
                    }
                },
                
                async deleteFromMongoDB(id) {
                    try {
                        await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer 9qVU9vgW1AdSZJL4WNZ2fzKtFC72',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                appSlug: 'packaging-questionnaire-app-101',
                                action: 'delete',
                                collection: 'responses',
                                id: id
                            })
                        });
                    } catch (error) {
                        console.error('MongoDB deletion failed:', error);
                        throw error;
                    }
                },
                
                downloadCSV() {
                    if (!this.responses.length) {
                        this.error = true;
                        this.errorMsg = 'No data available to download';
                        setTimeout(() => this.error = false, 3000);
                        return;
                    }
                    
                    // Create CSV header
                    const headers = Object.keys(this.responses[0]);
                    const csvContent = [
                        headers.join(','),
                        ...this.responses.map(row => 
                            headers.map(header => {
                                const value = row[header] !== undefined && row[header] !== null ? row[header].toString() : '';
                                // Escape quotes and enclose in quotes if necessary
                                return value.includes(',') || value.includes('"') || value.includes('\n') 
                                    ? `"${value.replace(/"/g, '""')}"` 
                                    : value;
                            }).join(',')
                        )
                    ].join('\n');
                    
                    // Create download link
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', 'packaging_questionnaire_data.csv');
                    
                    // Trigger download
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    // Hide floating menu if it was opened
                    this.showFloatingMenu = false;
                    
                    this.success = true;
                    this.successMsg = 'CSV file downloaded successfully';
                    setTimeout(() => this.success = false, 3000);
                }
            }
        }
    </script>
<script>document.body.addEventListener('wheel', e => { if (!e.ctrlKey) return; e.preventDefault(); return }, { passive: false })</script>
	</body>
</html>